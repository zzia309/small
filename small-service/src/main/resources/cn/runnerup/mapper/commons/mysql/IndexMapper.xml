<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.runnerup.mapper.commons.IndexMapper">
<resultMap id="BaseResultMap" type="cn.runnerup.kpi.model.KpiModel" >
	<result column="total" property="total" jdbcType="INTEGER" />
   	<result column="type" property="type" jdbcType="VARCHAR" />
   	<result column="sum" property="sum" jdbcType="DOUBLE" />
</resultMap>

<select id="selectBussinessCount" resultMap="BaseResultMap" parameterType="map" >
   	select
	   	count(*) as total,
	   	cs_cartype as type,
	   	sum(cs_carLoans) as sum
   	from
   	sp_businesses , sp_customers where buss_customer = cs_id
   	<if test="type != null">
		and cs_cartype = #{type}
   	</if>
	<if test="sales != null">
	    and cs_sales = #{sales}
	</if>
	<if test="branch != null">
	    and buss_branch = #{branch}
	</if>
	<if test="carno != null">
		and buss_carNo = #{carno}
	</if>
	<if test="start != null and end != null">
		and cs_created between #{start} and #{end}
	</if>
	group by cs_cartype;
</select>

<select id="selectProfits" resultMap="BaseResultMap" parameterType="map" >
	select
		SUM(buss_profits) as sum,
		'其他业务' as type
	from sp_businesses, sp_customers
	where buss_customer = cs_id and cs_carType not like  '%租赁%'
	<if test="start != null and end != null">
		and buss_finisiTime between #{start} and #{end}
	</if>
	union
	select
		SUM(buss_profits) as sum,
		'租赁业务' as type
	from sp_businesses, sp_customers
	where buss_customer = cs_id and cs_carType like  '%租赁%'
	<if test="start != null and end != null">
		and buss_finisiTime between #{start} and #{end}
	</if>
</select>

<select id="selectSales" resultMap="BaseResultMap" parameterType="map" >
	select
		count(*) as total ,
		SUM(cs_carLoans) as sum ,
		cs_sales as type
	from sp_businesses, sp_customers
	where buss_customer = cs_id
	<if test="sale != null">
		and cs_sales = #{sale}
	</if>
</select>




</mapper>